# Dynamic Report Credit Calculator

This repository contains a FastAPI application that calculates credits for dynamic reports based on message content and report data.

## Folder Structure
```
project/
├── docker/
│   └── Dockerfile
├── docs/
│   ├── current-period.json
│   ├── outcome.json
│   ├── report-example.json
├── src/
│   ├── __init__.py
│   ├── main.py
│   ├── models.py
│   ├── config.py
│   ├── repositories/
│   │   ├── message_repository.py
│   │   └── report_repository.py
│   ├── routes/
│   │   └── usage_routes.py
│   ├── services/
│   │   └── usage_service.py
│   ├── utils/
│   │   └── credit_calculator.py
│   ├── tests/
│   │   ├── test_calculate_credits.py
│   │   ├── test_routes.py
│   │   └── test_services.py
│   ├── requirements.txt
│   └── requirements-test.txt
├── terraform/
├── docker-compose.yml
└── README.md
```


## What This Repository Does

This application:
1. Fetches messages from an external API
2. For each message, it either fetches a corresponding report or calculates credits based on the message content
3. Returns a usage summary including message details and credit calculations

## Multi-Stage Dockerfile
The Dockerfile in this project likely uses multi-stage builds, which allow for creating multiple environments within a single Dockerfile. 

The deployment target is an additional build stage specifically for deployment purposes. This approach helps optimize the final image size and improve security by separating the build environment from the runtime environment

## How to Run the Program

1. Ensure you have Docker and Docker Compose installed on your system.
2. Clone this repository.
3. Navigate to the project root directory.
4. Update the docker-compose.yml file to have the URLS to fetch data.  
   `BASE_MESSAGES_URL: "http://****.test"`  
   `BASE_REPORTS_URL: "http://****.test"`  
5. Run the following command:  
   `docker-compose up --build`
6. The API will be available at:  
   `http://localhost:8000`

## Available Endpoints

- GET `/usage`: Returns the usage summary for all messages.

## Environment Variables

The following environment variables can be set in the `docker-compose.yml` file:

- `BASE_MESSAGES_URL`: The base URL for fetching messages (default: "http://localhost")
- `BASE_REPORTS_URL`: The base URL for fetching reports (default: "http://localhost")

## How to Run Tests

To run the tests, use the following command:  
`docker-compose run --rm app pytest`

This command will:
1. Start a new container
2. Run all the tests
3. Display the test results
4. Remove the container after completion

## Development

For development purposes, you can keep a container running and execute tests multiple times:

1. Start the container in detached mode:  
`docker-compose up -d`

2. Run unit tests:  
`docker-compose exec app pytest`

## Terraform Deployment (optional)

This project uses Terraform to deploy the AWS Lambda function and its associated resources. The Terraform configuration is located in the `terraform` directory.

### Prerequisites

- Ensure you have [Terraform](https://www.terraform.io/downloads.html) installed.
- Configure your AWS credentials. You can set them up using the AWS CLI or by exporting environment variables.

### Running Terraform

1. **Navigate to the Terraform Directory**:  
`cd ./terraform/`
2. **Initialize Terraform**:  
   This command initializes the working directory containing the Terraform configuration files.  
`terraform init`
3. **Create a `prod.tfvars` File from the template and replace the values**:  
   Create a file named `prod.tfvars` in the `terraform` directory to specify environment-specific variables.  
3. **Create the workspace**:  
`terraform workspace new prod`
4. **Plan the Terraform Configuration**  
   This will show resources bein created on AWS  
`terraform plan -var-file="prod.tfvars"`
5. **Apply the Terraform Configuration**:  
   Use the following command to apply the configuration and create the resources defined in your Terraform files:  
`terraform apply -var-file="prod.tfvars"`
6. **Confirm Changes**:  
   When prompted, type `yes` to confirm that you want to create the resources.

### Understanding the Terraform Code

The Terraform code consists of several key components:

- **IAM Roles and Policies**: Defines roles and permissions for the Lambda function.
- **Lambda Function**: Configures the AWS Lambda function, including its code package and execution role.
- **VPC Configuration**: Connects the Lambda function to specified subnets and security groups.
- **CloudWatch Log Group**: Creates a log group for monitoring logs generated by the Lambda function.
- **Archive File**: Packages all source code files into a zip file for deployment.

### Cleanup

To remove all resources created by Terraform, you can run:  
`terraform destroy -var-file="prod.tfvars"`

## Contributing

1. Fork the repository and learn more about terraform + lambda + python

## License

This project is licensed under the MIT License.
